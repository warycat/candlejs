var Camera=function(t,e,i,n,h){this._canvas=t,this._ctx=t.getContext("2d"),this._width=t.width,this._height=t.height,this._ppc=e,this._resolution=Math.floor(this._width/this._ppc),this._range=i,this._focus=n,this._plane=h,this._columns=[],this._rays=[]};Camera.prototype={get canvas(){return this._canvas},get ctx(){return this._ctx},get width(){return this._width},get height(){return this._height},get ppc(){return this._ppc},get resolution(){return this._resolution},get range(){return this._range},get focus(){return this._focus},get plane(){return this._plane},get columns(){return this._columns},get rays(){return this._rays}},Camera.prototype.render=function(){},Camera.prototype.castRays=function(t){for(var e=this.ctx,i=this.ppc,n=0;n<this.resolution;n++){var h=n/this.resolution-.5,r=Math.atan2(h,this.focus),o=this.castRay(t.position,t.theta+r);this.rays[n]=o;for(var c=this.ppc*n,a=0;a<o.length&&o[a].height<=0;)a++;for(var s=o.length-1;s>=0;s--){var u=o[s];if(s===a){var g=this.plane.image,f=this.project(u.height,r,u.distance),p=Math.floor(128*(u.texture-1+u.offset));e.drawImage(g,p,0,1,g.height/2,c,f.top,i,f.height)}}}},Camera.prototype.castRay=function(t,e){var i=Math.sin(e),n=Math.cos(e),h=this,r=function(t,e,i,n,h){if(0===e)return{length2:1/0};var r=e>0?Math.floor(i+1)-i:Math.ceil(i-1)-i,o=r*(t/e);return{x:h?n+o:i+r,y:h?i+r:n+o,length2:r*r+o*o}},o=function(t,e,r,o,c){var a=0>n?e:0,s=0>i?r:0,u=h.plane.getGrid(Math.floor(t.x-a),Math.floor(t.y-s));return t.texture=u>0?u:0,t.height=u>0?1:0,t.distance=o+Math.sqrt(t.length2),t.shading=e?0>n?2:0:0>i?2:1,t.offset=c-Math.floor(c),t},c=function(t){var e=r(i,n,t.x,t.y,!1),a=r(n,i,t.y,t.x,!0),s=e.length2<a.length2?o(e,1,0,t.distance,e.y):o(a,0,1,t.distance,a.x);return s.distance>h.range?[t]:[t].concat(c(s))},a={x:t.x,y:t.y,height:0,distance:0};return c(a)},Camera.prototype.project=function(t,e,i){var n=i*Math.cos(e),h=this.height*t/n,r=this.height/2*(1+1/n);return{top:r-h,height:h}};