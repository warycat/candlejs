<!DOCTYPE html>

<html>
<head>
  <title>camera.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="artifact.html">
                  artifact.js
                </a>
              
                
                <a class="source" href="bot.html">
                  bot.js
                </a>
              
                
                <a class="source" href="camera.html">
                  camera.js
                </a>
              
                
                <a class="source" href="candle.html">
                  candle.js
                </a>
              
                
                <a class="source" href="entity.html">
                  entity.js
                </a>
              
                
                <a class="source" href="god.html">
                  god.js
                </a>
              
                
                <a class="source" href="keyboard.html">
                  keyboard.js
                </a>
              
                
                <a class="source" href="label.html">
                  label.js
                </a>
              
                
                <a class="source" href="level.html">
                  level.js
                </a>
              
                
                <a class="source" href="loop.html">
                  loop.js
                </a>
              
                
                <a class="source" href="main.html">
                  main.js
                </a>
              
                
                <a class="source" href="plane.html">
                  plane.js
                </a>
              
                
                <a class="source" href="player.html">
                  player.js
                </a>
              
                
                <a class="source" href="sky.html">
                  sky.js
                </a>
              
                
                <a class="source" href="sprite.html">
                  sprite.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>camera.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* global Candle */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Camera = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">canvas, ppc, range, focus, plane</span>)</span>{
  <span class="hljs-keyword">this</span>._canvas = canvas;
  <span class="hljs-keyword">this</span>._ctx = canvas.getContext(<span class="hljs-string">'2d'</span>);
  <span class="hljs-keyword">this</span>._ppc = ppc;
  <span class="hljs-keyword">this</span>._resolution = <span class="hljs-built_in">Math</span>.floor(canvas.width / <span class="hljs-keyword">this</span>._ppc);
  <span class="hljs-keyword">this</span>._range = range;
  <span class="hljs-keyword">this</span>._focus = focus;
  <span class="hljs-keyword">this</span>._plane = plane;
  <span class="hljs-keyword">this</span>._columns = [];
  <span class="hljs-keyword">this</span>._rays = [];
  <span class="hljs-keyword">this</span>._render = [];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Camera.prototype = {
  get canvas(){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._canvas;
  }
, get ctx(){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._ctx;
  }
, get ppc(){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._ppc;
  }
, get resolution(){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._resolution;
  }
, get range(){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._range;
  }
, get focus(){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._focus;
  }
, get plane(){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._plane;
  }
, get columns(){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._columns;
  }
, get rays(){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._rays;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Render function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Camera.prototype.render = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._render;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Camera cast all rays from holder</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Camera.prototype.castRays = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">holder</span>)</span>{
  <span class="hljs-keyword">var</span> texture = <span class="hljs-keyword">this</span>.plane.image;
  <span class="hljs-keyword">var</span> width = <span class="hljs-keyword">this</span>.ppc;

  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.resolution; i++){
    <span class="hljs-keyword">var</span> y = i / <span class="hljs-keyword">this</span>.resolution - <span class="hljs-number">0.5</span>;
    <span class="hljs-keyword">var</span> angle = <span class="hljs-built_in">Math</span>.atan2(y, <span class="hljs-keyword">this</span>.focus);
    <span class="hljs-keyword">var</span> ray = <span class="hljs-keyword">this</span>.castRay(holder.position, holder.theta + angle);
    <span class="hljs-keyword">this</span>.rays[i] = ray;
    <span class="hljs-keyword">var</span> left = <span class="hljs-keyword">this</span>.ppc * i;
    <span class="hljs-keyword">var</span> hit = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">while</span> (hit &lt; ray.length &amp;&amp; ray[hit].height &lt;= <span class="hljs-number">0</span>){
      hit++;
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> s = ray.length - <span class="hljs-number">1</span>; s &gt;= <span class="hljs-number">0</span>; s--) {
      <span class="hljs-keyword">var</span> step = ray[s];
      <span class="hljs-keyword">if</span> (s === hit) {
        <span class="hljs-keyword">var</span> wall = <span class="hljs-keyword">this</span>.project(step.height, angle, step.distance);
        <span class="hljs-keyword">var</span> textureX = <span class="hljs-built_in">Math</span>.floor(Candle.PPU * (step.texture - <span class="hljs-number">1</span> + step.offset));
        <span class="hljs-keyword">this</span>._render[i] = {
          distance: step.distance
        , texture: texture
        , sx: textureX
        , sy: <span class="hljs-number">0</span>
        , sw: <span class="hljs-number">1</span>
        , sh: Candle.PPU
        , dx: left
        , dy: wall.top
        , dw: width
        , dh: wall.height
        };
        <span class="hljs-keyword">break</span>;
      }<span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">this</span>._render[i] = <span class="hljs-literal">null</span>;
      }
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Camera cast a single ray</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Camera.prototype.castRay = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">position, angle</span>)</span>{
  <span class="hljs-keyword">var</span> sin = <span class="hljs-built_in">Math</span>.sin(angle);
  <span class="hljs-keyword">var</span> cos = <span class="hljs-built_in">Math</span>.cos(angle);
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

  <span class="hljs-keyword">var</span> step_ = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">rise, run, x, y, inverted</span>) </span>{
    <span class="hljs-keyword">if</span> (run === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> { length2: <span class="hljs-literal">Infinity</span> };
    }

    <span class="hljs-keyword">var</span> dx = run &gt; <span class="hljs-number">0</span> ? <span class="hljs-built_in">Math</span>.floor(x + <span class="hljs-number">1</span>) - x : <span class="hljs-built_in">Math</span>.ceil(x - <span class="hljs-number">1</span>) - x;
    <span class="hljs-keyword">var</span> dy = dx * (rise / run);
    <span class="hljs-keyword">return</span> {
      x: inverted ? y + dy : x + dx,
      y: inverted ? x + dx : y + dy,
      length2: dx * dx + dy * dy
    };
  };

  <span class="hljs-keyword">var</span> inspect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">step, shiftX, shiftY, distance, offset</span>) </span>{
    <span class="hljs-keyword">var</span> dx = cos &lt; <span class="hljs-number">0</span> ? shiftX : <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> dy = sin &lt; <span class="hljs-number">0</span> ? shiftY : <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> grid = self.plane.getWall(<span class="hljs-built_in">Math</span>.floor(step.x - dx), <span class="hljs-built_in">Math</span>.floor(step.y - dy));
    step.texture = grid &gt; <span class="hljs-number">0</span> ? grid : <span class="hljs-number">0</span>;
    step.height = grid &gt; <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
    step.distance = distance + <span class="hljs-built_in">Math</span>.sqrt(step.length2);
    <span class="hljs-keyword">if</span> (shiftX) {
      step.shading = cos &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">2</span> : <span class="hljs-number">0</span>;
    }<span class="hljs-keyword">else</span>{
      step.shading = sin &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">2</span> : <span class="hljs-number">1</span>;
    }
    step.offset = offset - <span class="hljs-built_in">Math</span>.floor(offset);
    <span class="hljs-keyword">return</span> step;
  };

  <span class="hljs-keyword">var</span> ray = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">origin</span>) </span>{
    <span class="hljs-keyword">var</span> stepX = step_(sin, cos, origin.x, origin.y, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">var</span> stepY = step_(cos, sin, origin.y, origin.x, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">var</span> nextStep = stepX.length2 &lt; stepY.length2 ? inspect(stepX, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, origin.distance, stepX.y) : inspect(stepY, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, origin.distance, stepY.x);

    <span class="hljs-keyword">if</span> (nextStep.distance &gt; self.range){
      <span class="hljs-keyword">return</span> [origin];
    }
    <span class="hljs-keyword">return</span> [origin].concat(ray(nextStep));
  };

  <span class="hljs-keyword">var</span> point = {
    x: position.x
  , y: position.y
  , height: <span class="hljs-number">0</span>
  , distance: <span class="hljs-number">0</span>
  };

  <span class="hljs-keyword">return</span> ray(point);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Fisheye fix</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Camera.prototype.project = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">height, angle, distance</span>) </span>{
  <span class="hljs-keyword">var</span> z = distance * <span class="hljs-built_in">Math</span>.cos(angle);
  <span class="hljs-keyword">var</span> wallHeight = <span class="hljs-keyword">this</span>.canvas.height * height / z;
  <span class="hljs-keyword">var</span> bottom = <span class="hljs-keyword">this</span>.canvas.height / <span class="hljs-number">2</span> * (<span class="hljs-number">1</span> + <span class="hljs-number">1</span> / z);
  <span class="hljs-keyword">return</span> {
    top: bottom - wallHeight,
    height: wallHeight
  };
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
